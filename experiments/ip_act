#!/usr/bin/python3
from subprocess import Popen, PIPE
import shelve as sh, random as rd
from sys import argv as sysargv

def __shellIpSet(ip):
	print(Popen(['echo','"IP component selected for IP '+ip+'"'], stdout=PIPE).communicate()[0].decode('utf8'))
	startLogString  = "IP component is starting:" + Popen(['date','+%T+%N'], stdout=PIPE).communicate()[0].decode('utf8')
	Popen(['logger', startLogString])
	return Popen('ip addr add'.split(' ')+[ip]+'dev eth0'.split(' '), stdout=PIPE).communicate()[0].decode('utf8')

def __shellIpDel(ip):
	print(Popen(['echo','"IP component terminating for IP '+ip+'"'], stdout=PIPE).communicate()[0].decode('utf8'))
	startLogString  = "component is terminating:" + Popen(['date','+%T+%N'], stdout=PIPE).communicate()[0].decode('utf8')
	Popen(['logger', startLogString])
	return Popen('ip addr del'.split(' ')+[ip]+'dev eth0'.split(' '), stdout=PIPE).communicate()[0].decode('utf8')

def ipSet():
	ip = "172.16.159."+str(rd.randint(180,254))+"/24"
	execRet = __shellIpSet(ip)
	if execRet=="":
		with sh.open('/tmp/tempDb') as db:
			if 'ipList' not in db:
				db['ipList']=[ip]
			else:
				tl = db['ipList']
				if ip not in tl:
					tl.append(ip)
				db['ipList'] = tl
			print(db['ipList'])
	else:
		print(execRet)

def ipDel(ip):
	pass

def ipClearAll():
	with sh.open('/tmp/tempDb') as db:
		if 'ipList' in db:
			ipl = db['ipList']
			for ip in ipl:
				execRet = __shellIpDel(ip)
				if execRet=="":
					ipl.remove(ip)
				else:
					print(execRet)
			db['ipList'] = []
	ipAddr = Popen(['ip','addr'], stdout=PIPE).communicate()[0].decode('utf8')	
	for line in ipAddr.split('\n'):
		if 'eth0:' in line.split(' '):
			print(line)

if __name__=='__main__':
	if len(sysargv)==2 and sysargv[1]=='-set':
		ipSet()
	elif len(sysargv)==2 and sysargv[1]=='-delall':
		ipClearAll()
	elif len(sysargv)==2 and sysargv[1]=='-showdb':
		with sh.open('/tmp/tempDb') as db:
			print(db['ipList'])
	elif len(sysargv)==2 and sysargv[1]=='-flushdb':
		with sh.open('/tmp/tempDb') as db:
			db['ipList']=[]
	else:
		exit()